use rand::rngs::OsRng;
use rand::RngCore;

pub type Fe = u64;
pub type DoubleFe = u128;
pub const FE_BITS: u32 = 64;

pub const P: Fe=18446744073692774401;
const MAGIC: DoubleFe=18446744073726328831;
pub const GENS: [Fe; 25]= [1, 18446744073692774400, 2343296726962034558, 13683350544919123341, 13243642551692428821, 10874964387462881609, 7534481705907006399, 5348901840288879004, 5308308993055615628, 103137596001382966, 4001100309595846642, 4747701516324579050, 7849622933369365709, 5698525778536966835, 16110436979682639202, 16657233620895781866, 4714388797948037548, 291462435965019265, 14019328947695404893, 12574502747690961003, 9692560158355756265, 5610089774187920883, 8923397557944512334, 11127674213195597616, 7554718977942093330];
pub const IGENS: [Fe; 25]= [1, 18446744073692774400, 16103447346730739843, 5043905678433485007, 2746981288922994671, 7982924710107710945, 2346829023448270050, 17994379443834238648, 17261835925850121293, 17588984312544301487, 903407078998275713, 11693998047149568919, 9560886936791565106, 188498105952525229, 12078863509863891573, 8056062278674607448, 15199916114136853210, 6789217647312365436, 12928819545134833299, 3210964843350086006, 8925448351568202528, 9576007003831336726, 9012318726087512385, 5828127046315378420, 3461348672691625677];
pub const N_INVS: [Fe; 25]= [1, 9223372036846387201, 13835058055269580801, 16140901064481177601, 17293822569086976001, 17870283321389875201, 18158513697541324801, 18302628885617049601, 18374686479654912001, 18410715276673843201, 18428729675183308801, 18437736874438041601, 18442240474065408001, 18444492273879091201, 18445618173785932801, 18446181123739353601, 18446462598716064001, 18446603336204419201, 18446673704948596801, 18446708889320685601, 18446726481506730001, 18446735277599752201, 18446739675646263301, 18446741874669518851, 18446742974181146626];


pub fn mult(a: Fe, b: Fe) -> Fe {
    let x = a as DoubleFe * b as DoubleFe;
    let q = ((x >> FE_BITS) * MAGIC) >> FE_BITS;
    let r = x - q * (P as DoubleFe);
    let mut r = r as DoubleFe;
    if r >= P as DoubleFe {
        r -= P as DoubleFe;
    }
    if r >= P as DoubleFe {
        r -= P as DoubleFe;
    }
    r as Fe
}

pub fn add(a: Fe, b: Fe) -> Fe {
    let mut x = a as DoubleFe + b as DoubleFe;
    if x >= P as DoubleFe {
        x -= P as DoubleFe;
    }
    x as Fe
}

pub fn sub(a: Fe, b: Fe) -> Fe {
    let mut x = P as DoubleFe + a as DoubleFe - b as DoubleFe;
    if x >= P as DoubleFe {
        x -= P as DoubleFe;
    }
    x as Fe
}

pub fn generate_random_element() -> Fe {
    loop {
        let mut buf = [0u8; std::mem::size_of::<Fe>()];
        OsRng.fill_bytes(&mut buf);
        let num = Fe::from_le_bytes(buf);
        if num < Fe::MAX - (Fe::MAX % P) {
            return num % P;
        }
    }
}

pub fn modular_inverse(a: Fe) -> Fe {
    let mut result = Fe::from(1u8);
    let mut base = a;
    let mut exp = P - 2;

    while exp > 0 {
        if exp & 1 == 1 {
            result = mult(result, base);
        }
        base = mult(base, base);
        exp >>= 1;
    }
    result
}
